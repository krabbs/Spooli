<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Prusa MMU3 Filament‑Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Prusa-Style Farben */
    :root {
      --prusa-orange: #f2801b;
      --bg-dark: #2a2a2a;
      --bg-light: #f7f7f7;
      --card-bg: #ffffff;
      --text-dark: #333333;
      --text-light: #ffffff;
    }
    body {
      font-family: 'Open Sans', sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 90vh;
    }
    header {
      background: var(--prusa-orange);
      padding: 1rem;
      color: var(--text-light);
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
    }
    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    .card {
      background: var(--card-bg);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-radius: 8px;
      margin: 1rem;
      padding: 1rem;
      overflow-y: auto;
      position: relative;
    }
    #spool-card {
      flex: 1;
    }
    #chart-card {
      flex: 1;
    } {
      flex: 2;
    }
    h2 {
      color: var(--prusa-orange);
      margin-top: 0;
    }
    .shine-overlay {
      content: "";
      position: absolute;
      top: 0;
      left: -50%;
      width: 50%;
      height: 100%;
      background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
      transform: skewX(-20deg);
      pointer-events: none;
      z-index: 2;
      animation: none;
    }
    .printing .shine-overlay {
      animation: shine-move 2.5s linear infinite;
    }
    @keyframes shine-move {
      0% { left: -50%; }
      100% { left: 150%; }
    }
    #spool-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .spool-item {
      margin: 0.75rem 0;
    }
    .spool-label {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      position: relative;
      z-index: 3;
    }
    .bar-container {
      background: #eee;
      border-radius: 6px;
      height: 14px;
      overflow: hidden;
      margin-top: 0.3rem;
      position: relative;
      z-index: 3;
    }
    .bar {
      height: 100%;
      background: var(--prusa-orange);
      transition: width 0.4s ease;
    }
    .editable {
      cursor: pointer;
      border-bottom: 1px dashed var(--prusa-orange);
    }
    #status-bar {
      background: var(--bg-dark);
      color: var(--text-light);
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-around;
    }
    #status-bar div {
      font-size: 0.9rem;
    }
    canvas { background: var(--card-bg); border-radius: 8px; }
    #chart-card.disabled { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <header>Prusa MMU3 Filament‑Monitor</header>
  <main>
    <div id="spool-card" class="card {{ 'printing' if tool_state in ['PRINTING','PAUSED'] else '' }}">
      <div class="shine-overlay"></div>
      <h2>Restgewicht pro Spule</h2>
      <ul id="spool-list">
        {% set max_weight = spool_state.values() | max if spool_state else 1000 %}
        {% for t, g in spool_state.items() %}
          <li class="spool-item">
            <div class="spool-label">
              <span>Tool {{ t }}</span>
              <span><span class="editable" data-tool="{{ t }}">{{ g|round(1) }}</span> g</span>
            </div>
            <div class="bar-container"><div class="bar" style="width: {{ (g/max_weight*100)|round(1) }}%"></div></div>
          </li>
        {% endfor %}
      </ul>
    </div>
    <div id="chart-card" class="card {{ 'disabled' if tool_state=='IDLE' else '' }}">
      <h2>Aktueller Filamentverbrauch</h2>
      <canvas id="liveChart"></canvas>
    </div>
  </main>
  <div id="status-bar">
    <div><strong>MMU:</strong> <span id="tool_state">{{ tool_mmu }}</span></div>
    <div><strong>Status:</strong> <span id="tool_state">{{ tool_state }}</span></div>
    <div><strong>Fortschritt:</strong> <span id="tool_progress">{{ tool_progress }}%</span></div>
    <div><strong>Job:</strong> <span id="tool_job">{{ tool_job }}</span></div>
    <div><strong>live:</strong> <span id="tool_live">{{ tool_live }}</span></div>
  </div>

  <script>
    // Chart.js Setup
    const ctx = document.getElementById('liveChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [], datasets: [
          {% for t in tool_indices %}
            {label:'Tool {{ t }}',data:[],fill:false,borderColor:'#{{ tool_colors[t] }}',tension:0.2},
          {% endfor %}
        ]
      },
      options: { responsive:true, animation:false, scales:{ x:{title:{display:true,text:'Fortschritt %'}}, y:{title:{display:true,text:'Filament mm'},beginAtZero:true} } }
    });

    async function updateData() {
      // Chart
      const pts = await fetch('/data').then(r=>r.json());
      chart.data.labels = pts.map(p=>p[0].toFixed(1));
      chart.data.datasets.forEach((ds,i)=> ds.data = pts.map(p=>p[1][i]||0));
      chart.update();

      // Status
      const st = await fetch('/status').then(r=>r.json());
      document.getElementById('tool_state').textContent = st.tool_state;
      document.getElementById('tool_progress').textContent = st.tool_progress.toFixed(1) + '%';
      document.getElementById('tool_job').textContent = st.tool_job;
      document.getElementById('tool_mmu').textContent = st.tool_mmu;
      document.getElementById('tool_live').textContent = st.tool_live;
      document.getElementById('spool-card').classList.toggle('printing', ['PRINTING','PAUSED'].includes(st.tool_state));
      document.getElementById('chart-card').classList.toggle('disabled', st.tool_state==='IDLE');
    }

    // Editable spools
    document.querySelectorAll('.editable').forEach(span => {
      span.addEventListener('click', () => {
        const tool = span.dataset.tool;
        const oldVal = parseFloat(span.textContent).toFixed(1);
        const input = document.createElement('input');
        input.type = 'number'; input.value = oldVal; input.step = '0.1';
        span.replaceWith(input);
        input.focus();
        // Blur-Handler: nur Text aktualisieren, kein Duplikat
        input.addEventListener('blur', () => {
          const newVal = parseFloat(input.value).toFixed(1);
          // Update Backend
          fetch(`/set_spool_weight/${tool}/${newVal}`, { method: 'POST' })
            .then(() => {
              // Update Bar-Breite
              const item = input.closest('.spool-item');
              const bar = item.querySelector('.bar');
              // maximaler Wert neu berechnen
              const weights = Array.from(document.querySelectorAll('.editable')).map(s => parseFloat(s.textContent));
              const maxW = Math.max(...weights, 1);
              bar.style.width = `${(newVal / maxW) * 100}%`;
              // Ersatz: neues Span
              const newSpan = document.createElement('span');
              newSpan.className = 'editable';
              newSpan.dataset.tool = tool;
              newSpan.textContent = newVal;
              input.replaceWith(newSpan);
              // Rebind listener
              newSpan.addEventListener('click', span.click);
            });
        });
      });
    });

    setInterval(updateData, 2000);
    updateData();
    updateData();
  </script>
</body>
</html>

